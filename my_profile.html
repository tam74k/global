<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind + Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- خط Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>html,body{font-family:"Cairo",ui-sans-serif,system-ui}</style>

  <!-- إعدادات الشركة -->
  <script type="module" src="./js/config.js"></script>

  <!-- تثبيت رابط الشعار مباشرة هنا -->
  <script>
    window.COMPANY_LOGO_URL = "https://tam74k.github.io/global/Logo1.png";
    try { localStorage.setItem('COMPANY_LOGO_URL', window.COMPANY_LOGO_URL); } catch(e){}
  </script>

  <!-- تشغيل الـ branding بعد ضبط الرابط -->
  <script type="module" src="./js/brand.js"></script>

  <title>بياناتي | GSSG</title>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="toast-holder" class="fixed top-4 right-4 z-50"></div>

  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-blue-50 ring-2 ring-blue-100 flex items-center justify-center overflow-hidden">
          <!-- نخلي fallback ظاهر افتراضيًا، والصورة تظهر بعد التحميل -->
          <img id="companyLogo" referrerpolicy="no-referrer" crossorigin="anonymous"
               class="w-full h-full object-contain hidden" alt="logo">
          <svg id="logoFallback" class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <!-- (إصلاح مسار الأيقونة: حروف لاتينية صحيحة) -->
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 7l9-4 9 4-9 4-9-4zM3 7v10l9 4 9-4V7" />
          </svg>
        </div>
        <div>
          <h1 class="text-sm font-bold" data-company-ar></h1>
          <p class="text-xs text-gray-500" data-company-en></p>
        </div>
      </div>
      <div class="flex items-center gap-4 text-sm">
        <span id="roleBadge" class="px-2 py-1 text-xs rounded-full border bg-slate-50"></span>
        <a href="dashboard.html" class="text-blue-700 hover:underline">الرجوع</a>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-4">
    <h2 class="text-xl font-bold mb-4">بياناتي (عرض فقط)</h2>

    <section class="bg-white rounded-2xl shadow p-4 mb-4">
      <div id="nameRow" class="text-lg font-extrabold">—</div>
      <div id="jobRow"  class="text-sm text-gray-600">—</div>
    </section>

    <section class="bg-white rounded-2xl shadow p-4">
      <div id="profile" class="grid sm:grid-cols-2 md:grid-cols-3 gap-4">
        <!-- سيتم ملؤه بالـ JS -->
      </div>
      <div id="err" class="mt-4 text-red-600 text-sm hidden"></div>
    </section>
  </main>

  <script type="module">
    import { requireAuth } from './js/auth.js';
    import { setRoleBadge } from './js/ui.js';

    const errBox = document.getElementById('err');

    function showError(msg) {
      errBox.textContent = msg || 'حدث خطأ غير متوقع.';
      errBox.classList.remove('hidden');
    }

    try {
      const ctx = await requireAuth(['employee','supervisor']);
      if (!ctx) {
        // تم تحويله لصفحة الدخول بواسطة requireAuth
        // لا نفعل شيئًا هنا
      } else {
        // شارة الدور
        setRoleBadge(ctx.role || 'employee');

        const u = ctx.userRow || {};
        // اسم + كود وظيفي أعلى الصفحة
        document.getElementById('nameRow').textContent = u.Name || u.En_Name || '—';
        document.getElementById('jobRow').textContent  = 'الكود الوظيفي: ' + (u.jobID || '—');

        // تسميات عربية لحقول users
        const labels = {
          id:'UUID', created_at:'تاريخ الإنشاء', email:'البريد', mobile:'الموبايل',
          jobID:'الكود الوظيفي', Name:'الاسم', En_Name:'الاسم (EN)',
          Active:'نشط', NAT:'الجنسية', POS2:'المسمى', Gun:'سلاح',
          Mwaten:'مواطن', location:'الموقع', Gendar:'النوع',
          Start_in_Location:'بداية الموقع', FpCode:'كود البصمة',
          Civil_Id:'الرقم المدني', B_date:'الميلاد', pic:'الصورة',
          SupervisorId:'كود المشرف', Roll:'الدور'
        };

        const profile = document.getElementById('profile');
        const ordered = Object.keys(labels).filter(k => Object.prototype.hasOwnProperty.call(u, k));

        // لو ما فيش ولا حقل، اعرض رسالة بدل ما تبقى الصفحة فاضية
        if (!ordered.length) {
          profile.innerHTML = `
            <div class="text-gray-600">لا توجد بيانات لعرضها من جدول <span class="font-mono">users</span>.</div>
          `;
        } else {
          profile.innerHTML = ordered.map(k => `
            <div class="rounded-xl border p-3">
              <div class="text-xs text-gray-500">${labels[k] || k}</div>
              <div class="font-bold break-words">${u[k] === null || u[k] === undefined ? '—' : u[k]}</div>
            </div>
          `).join('');
        }
      }
    } catch (e) {
      console.error(e);
      showError(e.message || 'تعذر تحميل بيانات الملف الشخصي.');
    }
  </script>
</body>
</html>
