<!doctype html><html lang="ar" dir="rtl"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>html,body{font-family:"Cairo",ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans",sans-serif}</style>
<title>تسجيل</title></head>
<body class="min-h-screen bg-gray-50">
<div class="fixed top-4 right-4 z-50" id="toast-holder"></div>
<div class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow p-6 w-full max-w-xl">
    <h1 class="text-xl font-extrabold mb-4" data-company-ar></h1>
    <form id="regForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label>الكود الوظيفي</label><input id="jobID" class="w-full border rounded px-3 py-2" required></div>
      <div><label>نوع الحساب</label><select id="role" class="w-full border rounded px-3 py-2" required><option value="">اختر</option><option value="employee">موظف</option><option value="supervisor">مشرف</option></select></div>
      <div><label>الاسم</label><input id="name" class="w-full border rounded px-3 py-2" required></div>
      <div><label>كود المشرف (اختياري)</label><input id="supCode" class="w-full border rounded px-3 py-2"></div>
      <div><label>البريد</label><input id="email" type="email" class="w-full border rounded px-3 py-2" required></div>
      <div><label>الموبايل</label><input id="mobile" class="w-full border rounded px-3 py-2" required></div>
      <div class="md:col-span-2"><label>كلمة المرور</label><input id="password" type="password" class="w-full border rounded px-3 py-2" required></div>
      <div class="md:col-span-2"><button class="w-full bg-green-600 text-white rounded py-2">تسجيل</button></div>
    </form>
    <p class="text-sm text-center mt-4">لديك حساب؟ <a class="text-blue-600" href="index.html">دخول</a></p>
  </div>
</div>
<script type="module">
import { supabase } from './js/auth.js'; import { toast, setCompanyBranding } from './js/ui.js'; setCompanyBranding();
document.getElementById('regForm').addEventListener('submit', async (e)=>{ e.preventDefault();
 const email=document.getElementById('email').value.trim(), password=document.getElementById('password').value.trim(), name=document.getElementById('name').value.trim(), jobID=document.getElementById('jobID').value.trim(), mobile=document.getElementById('mobile').value.trim(), role=document.getElementById('role').value, supCode=document.getElementById('supCode').value.trim()||null;
 try{ let { data: authData, error: authErr } = await supabase.auth.signUp({ email, password }); if(authErr){ const m=(authErr.message||'').toLowerCase(); if(m.includes('already registered')) return toast('هذا البريد مسجّل مسبقًا','error'); return toast('تعذر إنشاء الحساب: '+authErr.message,'error'); }
  let uid = authData.user?.id || null; if(!uid){ const res = await supabase.auth.signInWithPassword({ email, password }); if(res.error){ const msg=(res.error.message||'').toLowerCase(); if(msg.includes('email')&&msg.includes('not')&&msg.includes('confirmed')){ toast('تم إنشاء الحساب. فعّل بريدك ثم سجّل الدخول.','success'); return; } return toast('تم إنشاء الحساب لكن تعذر تسجيل الدخول: '+res.error.message,'error'); } uid=res.data.user.id; }
  const row = { id: uid, email, mobile, jobID, Name: name, Roll: role, SupervisorCode: supCode, Active: true };
  let { error: insErr } = await supabase.from('users').insert([row]); if(insErr){ delete row['SupervisorCode']; const { error: retryErr } = await supabase.from('users').insert([row]); if(retryErr) return toast('تم إنشاء الحساب لكن فشل حفظ البيانات: '+retryErr.message,'error'); }
  toast('تم إنشاء الحساب بنجاح'); location.href='index.html';
 }catch{ toast('خطأ غير متوقع أثناء إنشاء الحساب','error'); }
});</script></body></html>