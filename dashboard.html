<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind + Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- خط Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>html,body{font-family:"Cairo",ui-sans-serif,system-ui}</style>

  <!-- إعدادات الشركة -->
  <script type="module" src="./js/config.js"></script>

  <!-- تعيين رابط الشعار مباشرة هنا -->
  <script>
    window.COMPANY_LOGO_URL = "https://tam74k.github.io/global/Logo1.png";
    try { localStorage.setItem('COMPANY_LOGO_URL', window.COMPANY_LOGO_URL); } catch(e){}
  </script>

  <!-- تحميل معالِج الشعار بعد ضبط الرابط -->
  <script type="module" src="./js/brand.js"></script>

  <title>الواجهة الرئيسية | GSSG</title>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="toast-holder" class="fixed top-4 right-4 z-50"></div>

  <!-- شريط علوي -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-blue-50 ring-2 ring-blue-100 flex items-center justify-center overflow-hidden">
          <!-- نجعل fallback ظاهر افتراضياً، والصورة مخفية حتى التحميل -->
          <img id="companyLogo" referrerpolicy="no-referrer" crossorigin="anonymous"
               class="w-full h-full object-contain hidden" alt="logo">
          <svg id="logoFallback" class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 7l9-4 9 4-9 4-9-4zM3 7v10l9 4 9-4V7" />
          </svg>
        </div>
        <div>
          <h1 class="text-sm font-bold" data-company-ar></h1>
          <p class="text-xs text-gray-500" data-company-en></p>
        </div>
      </div>

      <div class="flex items-center gap-4 text-sm">
        <span id="roleBadge" class="px-2 py-1 text-xs rounded-full border bg-slate-50"></span>
        <a href="#" id="logout" class="text-red-600 hover:underline">خروج</a>
      </div>
    </div>
  </nav>

  <!-- المحتوى -->
  <main class="max-w-7xl mx-auto p-4">
    <h2 class="text-xl font-bold mb-4">الواجهة الرئيسية</h2>
    <div id="cards" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- سيتم الرسم بالـ JS -->
    </div>
  </main>

  <script type="module">
    import { requireAuth } from './js/auth.js';
    import { setRoleBadge } from './js/ui.js';

    // بطاقات الواجهة
    const common = [
      { href:'my_profile.html',         icon:'🧾', title:'بياناتي',               sub:'عرض كامل لبياناتي (غير قابل للتعديل)' },
      { href:'my_attendance.html',      icon:'📊', title:'حضوري',                 sub:'تصفية بين تاريخين (الشهر الحالي افتراضيًا)' },
      { href:'my_violations.html',      icon:'⚠️', title:'مخالفاتي',              sub:'المخالفات المسجّلة عليّ' },
      { href:'leave_request.html',      icon:'🗓️', title:'طلب إجازة',            sub:'إرسال طلب إجازة' },
      { href:'permission_request.html', icon:'⏱️', title:'طلب إذن',               sub:'ساعات/خروج مؤقت' },
      { href:'hr_request.html',         icon:'📄', title:'طلب مستندات HR',        sub:'شهادات/خطابات' }
    ];

    const employeeOnly = [
      { href:'evaluate_supervisor.html', icon:'⭐', title:'تقييمي لمشرفي', sub:'مرة كل شهر' }
    ];

    const supervisorOnly = [
      { href:'attendance_register.html', icon:'🕒', title:'الحضور/الانصراف', sub:'يدوي + QR (اختيار نمط مرة واحدة)' },
      { href:'violations.html',          icon:'⚠️', title:'تسجيل مخالفة',   sub:'مطابق لنموذج NAT 300-004' },
      { href:'evaluate_employees.html',  icon:'⭐', title:'تقييم الموظفين',  sub:'تقييم شهري للمرؤوسين' },
      { href:'attendance_report.html',   icon:'📈', title:'تقارير الحضور',   sub:'تجميعي + تصدير CSV' },
      { href:'violations_list.html',     icon:'📝', title:'سجل الإنذارات',   sub:'تصفية/طباعة/CSV' },
      { href:'supervisor_home.html',     icon:'🏠', title:'لوحة المشرف',     sub:'ملخص يومي وحالة التقييم' }
    ];

    function renderCards(role = 'employee') {
      const isSup = (role || '').toLowerCase() === 'supervisor';
      const list = isSup ? [...supervisorOnly, ...common] : [...employeeOnly, ...common];

      const html = list.map(i => `
        <a href="${i.href}" class="bg-white rounded-2xl shadow p-4 flex items-center gap-3 hover:ring transition">
          <span class="text-xl">${i.icon}</span>
          <div>
            <p class="font-bold">${i.title}</p>
            <p class="text-sm text-gray-500">${i.sub}</p>
          </div>
        </a>
      `).join('');
      const cards = document.getElementById('cards');
      if (cards) cards.innerHTML = html;
    }

    async function boot() {
      try {
        const ctx = await requireAuth(['employee','supervisor']);
        if (!ctx) return; // تم التوجيه لصفحة الدخول بالفعل
        const role = (ctx.role || ctx.userRow?.Roll || 'employee').toLowerCase();

        setRoleBadge(role);
        renderCards(role);

        // خروج
        document.getElementById('logout')?.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            const { supabase } = await import('./js/auth.js');
            await supabase.auth.signOut();
          } catch {}
          location.href = 'index.html';
        });
      } catch (e) {
        console.error('Dashboard boot error:', e);
        // في حالة أي خطأ غير متوقع، اعرض الحد الأدنى للواجهة كموظف
        renderCards('employee');
      }
    }

    // لمعالجة العودة من صفحات أخرى بدون إعادة تحميل كاملة
    window.addEventListener('pageshow', boot);
    boot();
  </script>
</body>
</html>
