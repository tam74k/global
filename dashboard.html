<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind + Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Ø®Ø· Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>html,body{font-family:"Cairo",ui-sans-serif,system-ui}</style>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© -->
  <script type="module" src="./js/config.js"></script>

  <!-- ØªØ¹ÙŠÙŠÙ† Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù‡Ù†Ø§ -->
  <script>
    window.COMPANY_LOGO_URL = "https://tam74k.github.io/global/Logo1.png";
    try { localStorage.setItem('COMPANY_LOGO_URL', window.COMPANY_LOGO_URL); } catch(e){}
  </script>

  <!-- ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ø§Ù„ÙØ¬ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ Ø¶Ø¨Ø· Ø§Ù„Ø±Ø§Ø¨Ø· -->
  <script type="module" src="./js/brand.js"></script>

  <title>Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | GSSG</title>
</head>
<body class="min-h-screen bg-gray-50">
  <div id="toast-holder" class="fixed top-4 right-4 z-50"></div>

  <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-blue-50 ring-2 ring-blue-100 flex items-center justify-center overflow-hidden">
          <!-- Ù†Ø¬Ø¹Ù„ fallback Ø¸Ø§Ù‡Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ØŒ ÙˆØ§Ù„ØµÙˆØ±Ø© Ù…Ø®ÙÙŠØ© Ø­ØªÙ‰ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
          <img id="companyLogo" referrerpolicy="no-referrer" crossorigin="anonymous"
               class="w-full h-full object-contain hidden" alt="logo">
          <svg id="logoFallback" class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 7l9-4 9 4-9 4-9-4zM3 7v10l9 4 9-4V7" />
          </svg>
        </div>
        <div>
          <h1 class="text-sm font-bold" data-company-ar></h1>
          <p class="text-xs text-gray-500" data-company-en></p>
        </div>
      </div>

      <div class="flex items-center gap-4 text-sm">
        <span id="roleBadge" class="px-2 py-1 text-xs rounded-full border bg-slate-50"></span>
        <a href="#" id="logout" class="text-red-600 hover:underline">Ø®Ø±ÙˆØ¬</a>
      </div>
    </div>
  </nav>

  <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
  <main class="max-w-7xl mx-auto p-4">
    <h2 class="text-xl font-bold mb-4">Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
    <div id="cards" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <!-- Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„Ù€ JS -->
    </div>
  </main>

  <script type="module">
    import { requireAuth } from './js/auth.js';
    import { setRoleBadge } from './js/ui.js';

    // Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const common = [
      { href:'my_profile.html',         icon:'ğŸ§¾', title:'Ø¨ÙŠØ§Ù†Ø§ØªÙŠ',               sub:'Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ù„Ø¨ÙŠØ§Ù†Ø§ØªÙŠ (ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„)' },
      { href:'my_attendance.html',      icon:'ğŸ“Š', title:'Ø­Ø¶ÙˆØ±ÙŠ',                 sub:'ØªØµÙÙŠØ© Ø¨ÙŠÙ† ØªØ§Ø±ÙŠØ®ÙŠÙ† (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§)' },
      { href:'my_violations.html',      icon:'âš ï¸', title:'Ù…Ø®Ø§Ù„ÙØ§ØªÙŠ',              sub:'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„Ø© Ø¹Ù„ÙŠÙ‘' },
      { href:'leave_request.html',      icon:'ğŸ—“ï¸', title:'Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©',            sub:'Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø©' },
      { href:'permission_request.html', icon:'â±ï¸', title:'Ø·Ù„Ø¨ Ø¥Ø°Ù†',               sub:'Ø³Ø§Ø¹Ø§Øª/Ø®Ø±ÙˆØ¬ Ù…Ø¤Ù‚Øª' },
      { href:'hr_request.html',         icon:'ğŸ“„', title:'Ø·Ù„Ø¨ Ù…Ø³ØªÙ†Ø¯Ø§Øª HR',        sub:'Ø´Ù‡Ø§Ø¯Ø§Øª/Ø®Ø·Ø§Ø¨Ø§Øª' }
    ];

    const employeeOnly = [
      { href:'evaluate_supervisor.html', icon:'â­', title:'ØªÙ‚ÙŠÙŠÙ…ÙŠ Ù„Ù…Ø´Ø±ÙÙŠ', sub:'Ù…Ø±Ø© ÙƒÙ„ Ø´Ù‡Ø±' }
    ];

    const supervisorOnly = [
      { href:'attendance_register.html', icon:'ğŸ•’', title:'Ø§Ù„Ø­Ø¶ÙˆØ±/Ø§Ù„Ø§Ù†ØµØ±Ø§Ù', sub:'ÙŠØ¯ÙˆÙŠ + QR (Ø§Ø®ØªÙŠØ§Ø± Ù†Ù…Ø· Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)' },
      { href:'violations.html',          icon:'âš ï¸', title:'ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©',   sub:'Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù†Ù…ÙˆØ°Ø¬ NAT 300-004' },
      { href:'evaluate_employees.html',  icon:'â­', title:'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',  sub:'ØªÙ‚ÙŠÙŠÙ… Ø´Ù‡Ø±ÙŠ Ù„Ù„Ù…Ø±Ø¤ÙˆØ³ÙŠÙ†' },
      { href:'attendance_report.html',   icon:'ğŸ“ˆ', title:'ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ±',   sub:'ØªØ¬Ù…ÙŠØ¹ÙŠ + ØªØµØ¯ÙŠØ± CSV' },
      { href:'violations_list.html',     icon:'ğŸ“', title:'Ø³Ø¬Ù„ Ø§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª',   sub:'ØªØµÙÙŠØ©/Ø·Ø¨Ø§Ø¹Ø©/CSV' },
      { href:'supervisor_home.html',     icon:'ğŸ ', title:'Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù',     sub:'Ù…Ù„Ø®Øµ ÙŠÙˆÙ…ÙŠ ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…' }
    ];

    function renderCards(role = 'employee') {
      const isSup = (role || '').toLowerCase() === 'supervisor';
      const list = isSup ? [...supervisorOnly, ...common] : [...employeeOnly, ...common];

      const html = list.map(i => `
        <a href="${i.href}" class="bg-white rounded-2xl shadow p-4 flex items-center gap-3 hover:ring transition">
          <span class="text-xl">${i.icon}</span>
          <div>
            <p class="font-bold">${i.title}</p>
            <p class="text-sm text-gray-500">${i.sub}</p>
          </div>
        </a>
      `).join('');
      const cards = document.getElementById('cards');
      if (cards) cards.innerHTML = html;
    }

    async function boot() {
      try {
        const ctx = await requireAuth(['employee','supervisor']);
        if (!ctx) return; // ØªÙ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„
        const role = (ctx.role || ctx.userRow?.Roll || 'employee').toLowerCase();

        setRoleBadge(role);
        renderCards(role);

        // Ø®Ø±ÙˆØ¬
        document.getElementById('logout')?.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            const { supabase } = await import('./js/auth.js');
            await supabase.auth.signOut();
          } catch {}
          location.href = 'index.html';
        });
      } catch (e) {
        console.error('Dashboard boot error:', e);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø£ÙŠ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ÙƒÙ…ÙˆØ¸Ù
        renderCards('employee');
      }
    }

    // Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† ØµÙØ­Ø§Øª Ø£Ø®Ø±Ù‰ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒØ§Ù…Ù„Ø©
    window.addEventListener('pageshow', boot);
    boot();
  </script>
</body>
</html>
